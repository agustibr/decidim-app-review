{"ast":null,"code":"import dayjs from \"dayjs\";\n$(function () {\n  var sessionTimeOutEnabled = true;\n  var $timeoutModal = $(\"#timeoutModal\");\n  var timeoutInSeconds = parseInt($timeoutModal.data(\"session-timeout\"), 10);\n  var secondsUntilTimeoutPath = $timeoutModal.data(\"seconds-until-timeout-path\");\n  var heartbeatPath = $timeoutModal.data(\"heartbeat-path\");\n  var interval = parseInt($timeoutModal.data(\"session-timeout-interval\"), 10);\n  var preventTimeOutSeconds = $timeoutModal.data(\"prevent-timeout-seconds\");\n  var endsAt = dayjs().add(timeoutInSeconds, \"seconds\");\n  var lastAction = dayjs();\n  var $continueSessionButton = $(\"#continueSession\");\n  var lastActivityCheck = dayjs(); // 5 * 60 seconds = 5 Minutes\n\n  var activityCheckInterval = 5 * 60;\n  var preventTimeOutUntil = dayjs().add(preventTimeOutSeconds, \"seconds\"); // Ajax request is made at timeout_modal.html.erb\n\n  $continueSessionButton.on(\"click\", function () {\n    $timeoutModal.foundation(\"close\"); // In admin panel we have to hide all overlays\n\n    $(\".reveal-overlay\").css(\"display\", \"none\");\n    lastActivityCheck = dayjs();\n  });\n\n  if (isNaN(interval)) {\n    return;\n  }\n\n  if (!timeoutInSeconds) {\n    return;\n  }\n\n  var disableSessionTimeout = function disableSessionTimeout() {\n    sessionTimeOutEnabled = false;\n  };\n\n  var enableSessionTimeout = function enableSessionTimeout() {\n    sessionTimeOutEnabled = true;\n  };\n\n  var setTimer = function setTimer(secondsUntilExpiration) {\n    if (!secondsUntilExpiration) {\n      return;\n    }\n\n    endsAt = dayjs().add(secondsUntilExpiration, \"seconds\");\n  };\n\n  var sessionTimeLeft = function sessionTimeLeft() {\n    return $.ajax({\n      method: \"GET\",\n      url: secondsUntilTimeoutPath,\n      contentType: \"application/json\",\n      headers: {\n        \"X-CSRF-Token\": $(\"meta[name=csrf-token]\").attr(\"content\")\n      }\n    });\n  };\n\n  var heartbeat = function heartbeat() {\n    return $.ajax({\n      method: \"POST\",\n      url: heartbeatPath,\n      contentType: \"application/javascript\"\n    });\n  };\n\n  var userBeenActiveSince = function userBeenActiveSince(seconds) {\n    return (dayjs() - lastAction) / 1000 < seconds;\n  };\n\n  var exitInterval = setInterval(function () {\n    var timeSinceLastActivityCheckInSeconds = Math.round((dayjs() - lastActivityCheck) / 1000);\n    var popupOpen = $(\"#timeoutModal\").parent().css(\"display\") === \"block\";\n\n    if (!popupOpen && timeSinceLastActivityCheckInSeconds >= activityCheckInterval) {\n      lastActivityCheck = dayjs();\n\n      if (userBeenActiveSince(activityCheckInterval)) {\n        heartbeat();\n        return;\n      }\n    }\n\n    var timeRemaining = Math.round((endsAt - dayjs()) / 1000);\n\n    if (timeRemaining > 170) {\n      return;\n    }\n\n    if (dayjs() < preventTimeOutUntil) {\n      heartbeat();\n      return;\n    }\n\n    sessionTimeLeft().then(function (result) {\n      var secondsUntilSessionExpires = result.seconds_remaining;\n      setTimer(secondsUntilSessionExpires);\n\n      if (!sessionTimeOutEnabled) {\n        heartbeat();\n      } else if (secondsUntilSessionExpires <= 90) {\n        $timeoutModal.find(\"#reveal-hidden-sign-out\")[0].click();\n      } else if (secondsUntilSessionExpires <= 150) {\n        $timeoutModal.foundation(\"open\");\n      }\n    });\n  }, interval);\n  $(document).mousemove(function () {\n    lastAction = dayjs();\n  });\n  $(document).scroll(function () {\n    lastAction = dayjs();\n  });\n  $(document).keypress(function () {\n    lastAction = dayjs();\n  }); // Devise restarts its own timer on ajax requests,\n  // so here we restart our.\n\n  $(document).on(\"ajax:complete\", function () {\n    setTimer(timeoutInSeconds);\n  });\n  $(document).ajaxComplete(function (_event, _xhr, settings) {\n    if (settings && settings.url === secondsUntilTimeoutPath) {\n      return;\n    }\n\n    setTimer(timeoutInSeconds);\n  });\n  window.addEventListener(\"beforeunload\", function () {\n    clearInterval(exitInterval);\n    return;\n  });\n  window.Decidim.enableSessionTimeout = enableSessionTimeout;\n  window.Decidim.disableSessionTimeout = disableSessionTimeout;\n});","map":{"version":3,"mappings":"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","names":["dayjs","$","sessionTimeOutEnabled","$timeoutModal","timeoutInSeconds","parseInt","data","secondsUntilTimeoutPath","heartbeatPath","interval","preventTimeOutSeconds","endsAt","add","lastAction","$continueSessionButton","lastActivityCheck","activityCheckInterval","preventTimeOutUntil","on","foundation","css","isNaN","disableSessionTimeout","enableSessionTimeout","setTimer","secondsUntilExpiration","sessionTimeLeft","ajax","method","url","contentType","headers","attr","heartbeat","userBeenActiveSince","seconds","exitInterval","setInterval","timeSinceLastActivityCheckInSeconds","Math","round","popupOpen","parent","timeRemaining","then","result","secondsUntilSessionExpires","seconds_remaining","find","click","document","mousemove","scroll","keypress","ajaxComplete","_event","_xhr","settings","window","addEventListener","clearInterval","Decidim"],"sources":["/home/agustibr/.asdf/installs/ruby/3.0.2/lib/ruby/gems/3.0.0/bundler/gems/decidim-a25b5c74f78d/decidim-core/app/packs/src/decidim/session_timeouter.js"],"sourcesContent":["import dayjs from \"dayjs\"\n\n$(() => {\n  let sessionTimeOutEnabled = true;\n  const $timeoutModal = $(\"#timeoutModal\");\n  const timeoutInSeconds = parseInt($timeoutModal.data(\"session-timeout\"), 10);\n  const secondsUntilTimeoutPath = $timeoutModal.data(\"seconds-until-timeout-path\");\n  const heartbeatPath = $timeoutModal.data(\"heartbeat-path\");\n  const interval = parseInt($timeoutModal.data(\"session-timeout-interval\"), 10);\n  const preventTimeOutSeconds = $timeoutModal.data(\"prevent-timeout-seconds\");\n  let endsAt = dayjs().add(timeoutInSeconds, \"seconds\");\n  let lastAction = dayjs();\n  const $continueSessionButton = $(\"#continueSession\");\n  let lastActivityCheck = dayjs();\n  // 5 * 60 seconds = 5 Minutes\n  const activityCheckInterval = 5 * 60;\n  const preventTimeOutUntil = dayjs().add(preventTimeOutSeconds, \"seconds\");\n\n  // Ajax request is made at timeout_modal.html.erb\n  $continueSessionButton.on(\"click\", () => {\n    $timeoutModal.foundation(\"close\");\n    // In admin panel we have to hide all overlays\n    $(\".reveal-overlay\").css(\"display\", \"none\");\n    lastActivityCheck = dayjs();\n  })\n\n  if (isNaN(interval)) {\n    return;\n  }\n  if (!timeoutInSeconds) {\n    return;\n  }\n\n  const disableSessionTimeout = () => {\n    sessionTimeOutEnabled = false;\n  }\n\n  const enableSessionTimeout = () => {\n    sessionTimeOutEnabled = true;\n  }\n\n  const setTimer = (secondsUntilExpiration) => {\n    if (!secondsUntilExpiration) {\n      return;\n    }\n    endsAt = dayjs().add(secondsUntilExpiration, \"seconds\");\n  }\n\n  const sessionTimeLeft = () => {\n    return $.ajax({\n      method: \"GET\",\n      url: secondsUntilTimeoutPath,\n      contentType: \"application/json\",\n      headers: {\n        \"X-CSRF-Token\": $(\"meta[name=csrf-token]\").attr(\"content\")\n      }\n    });\n  }\n\n  const heartbeat = () => {\n    return $.ajax({\n      method: \"POST\",\n      url: heartbeatPath,\n      contentType: \"application/javascript\"\n    });\n  }\n\n  const userBeenActiveSince = (seconds) => {\n    return (dayjs() - lastAction) / 1000 < seconds;\n  }\n\n  const exitInterval = setInterval(() => {\n    const timeSinceLastActivityCheckInSeconds = Math.round((dayjs() - lastActivityCheck) / 1000);\n\n    const popupOpen = $(\"#timeoutModal\").parent().css(\"display\") === \"block\";\n    if (!popupOpen && timeSinceLastActivityCheckInSeconds >= activityCheckInterval) {\n      lastActivityCheck = dayjs();\n      if (userBeenActiveSince(activityCheckInterval)) {\n        heartbeat();\n        return;\n      }\n    }\n\n    const timeRemaining = Math.round((endsAt - dayjs()) / 1000);\n    if (timeRemaining > 170) {\n      return;\n    }\n\n    if (dayjs() < preventTimeOutUntil) {\n      heartbeat();\n      return;\n    }\n\n    sessionTimeLeft().then((result) => {\n      const secondsUntilSessionExpires = result.seconds_remaining;\n      setTimer(secondsUntilSessionExpires);\n\n      if (!sessionTimeOutEnabled) {\n        heartbeat();\n      } else if (secondsUntilSessionExpires <= 90) {\n        $timeoutModal.find(\"#reveal-hidden-sign-out\")[0].click();\n      } else if (secondsUntilSessionExpires <= 150) {\n        $timeoutModal.foundation(\"open\");\n      }\n    });\n  }, interval);\n\n  $(document).mousemove(() => {\n    lastAction = dayjs();\n  })\n  $(document).scroll(() => {\n    lastAction = dayjs();\n  })\n  $(document).keypress(() => {\n    lastAction = dayjs();\n  })\n\n  // Devise restarts its own timer on ajax requests,\n  // so here we restart our.\n  $(document).on(\"ajax:complete\", () => {\n    setTimer(timeoutInSeconds);\n  });\n\n  $(document).ajaxComplete((_event, _xhr, settings) => {\n    if (settings && settings.url === secondsUntilTimeoutPath) {\n      return;\n    }\n    setTimer(timeoutInSeconds);\n  });\n\n  window.addEventListener(\"beforeunload\", () => {\n    clearInterval(exitInterval);\n    return;\n  });\n\n  window.Decidim.enableSessionTimeout = enableSessionTimeout\n  window.Decidim.disableSessionTimeout = disableSessionTimeout\n});\n"]},"metadata":{},"sourceType":"module"}